machine:
  xcode:
    version: "7.3"
  test:
    override:
        - set -o pipefail &&
            xcodebuild
            CODE_SIGNING_REQUIRED=NO
            CODE_SIGN_IDENTITY=
            PROVISIONING_PROFILE=
            -sdk iphonesimulator
            -destination 'platform=iOS Simulator,OS=8.1,name=iPhone 6'
            -workspace TestCircleCi.xcworkspace
            -scheme "TestCircleCi"
            -derivedDataPath ./build
            analyze clean build test |
        tee $CIRCLE_ARTIFACTS/xcode_raw.log |
        xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml -scheme "TestCircleCi"
        clean build test |
      tee $CIRCLE_ARTIFACTS/xcode_raw.log |
      xcpretty --color --report junit --output $CIRCLE_TEST_REPORTS/xcode/results.xml

#   post:
#     - gem install cupertino
#     - security import ./certificates/xxx.p12 -k "login.keychain" -P "${PRIVATE_KEY_PASSPHRASE}" -T /usr/bin/codesign
#     - ios ios profiles:download "provision_name" -u "${user_id}" -p "${password}" --type distribution  --team "A_team"
#     - security import "cert_name.cer" -k "login.keychain" -T /usr/bin/codesign
#     - ios profiles:download "profile_name" -u "${user_id}" -p "${password}" --type distribution  --team "A_team"
#     - cp "profile_name.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles"
# deployment:
#   staging:
#     branch: master
#     commands:
#       - ipa build -w TestCircleCi.xcworkspace -s scheme_name -c Release -m "${profile_name.mobileprovision}" --sdk "iphoneos" --xcargs "CODE_SIGN_IDENTITY=\"CODE_SIGN_ID\"" --verbose
